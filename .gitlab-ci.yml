stages:
  - setup
  - test

variables:
  JUICESHOP_IMAGE: bkimminich/juice-shop
  JUICESHOP_CONTAINER_NAME: juice-shop
  JUICESHOP_PORT: 3000

services:
  - name: docker:dind
    alias: docker

before_script:
  - docker info

setup_juice_shop:
  stage: setup
  
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Pulling Juice Shop Docker image..."
    - docker pull $JUICESHOP_IMAGE
    - echo "Running Juice Shop container..."
    - docker run -d -p $JUICESHOP_PORT:3000 --name $JUICESHOP_CONTAINER_NAME $JUICESHOP_IMAGE
    - echo "Waiting for Juice Shop to initialize..."
    - sleep 15  
  artifacts:
    expire_in: 1 hour
    paths:
      - juice_shop_url.txt
  after_script:
    - docker ps -a

test_juice_shop:
  stage: test
  tags:
    - aws-ec2-docker
  image: curlimages/curl:latest
  dependencies:
    - setup_juice_shop
  script:
    - echo "Testing if Juice Shop is running..."
    - |
      STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$JUICESHOP_PORT/)
      if [ "$STATUS_CODE" -eq 200 ]; then
        echo "Juice Shop is running successfully."
      else
        echo "Failed to start Juice Shop. Status code: $STATUS_CODE"
        exit 1
      fi
