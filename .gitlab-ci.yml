stages:
  - start_services
  - security_scan
  - save_results
  - visualize

# 1ï¸âƒ£ Juice Shop ì‹¤í–‰ (ë¡œì»¬ì—ì„œ ì‹¤í–‰ë¨)
start_juice_shop:
  image: docker:latest
  stage: start_services
  services:
    - docker:dind
  tags:
    - euro-mac
  script:
    - echo "Checking if Juice Shop is already running..."
    - docker ps -a | grep "juice-shop" && docker rm -f juice-shop || echo "No existing container."
    - echo "Starting Juice Shop..."
    - docker run -d --name juice-shop -p 3000:3000 bkimminich/juice-shop
    - sleep 10
    - docker ps  

# 2ï¸âƒ£ OWASP ZAP ì‹¤í–‰ (Juice Shop íƒ€ê²Ÿ)
zap_scan:
  image: owasp/zap2docker-stable
  stage: security_scan
  dependencies:
    - start_juice_shop
  tags:
    - euro-mac
  before_script:
    - echo "ZAP_API_KEY=$ZAP_API_KEY" > ZAP/Main/.env
    - echo "TARGET_URL=$TARGET_URL" > ZAP/Main/.env
    - pip3 install zaproxy
    - pip3 install python-dotenv

  script:
    - echo "Running OWASP ZAP against Juice Shop..."
    - python3 ZAP/Main/zap_exec.py
    - python3 ZAP/Main/main.py
  artifacts:
    paths:
      - zap_results.json
      - zap_report.html

# 3ï¸âƒ£ JSON ë°ì´í„°ë¥¼ PostgreSQLì— ì €ì¥
save_to_db:
  image: python:3.9
  stage: save_results
  dependencies:
    - zap_scan
  before_script:
    - pip3 install psycopg2-binary
  tags:
    - euro-mac
  script:
    - python3 ZAP/Main/server.py
  allow_failure: false

# 4ï¸âƒ£ Grafanaì—ì„œ ë°ì´í„° ì‹œê°í™” + ë°ì´í„° ì†ŒìŠ¤ ë° ëŒ€ì‹œë³´ë“œ ìë™ ì¶”ê°€
grafana_visualization:
  stage: visualize
  tags:
    - euro-mac
  script:
    - echo "Stopping any existing Grafana container..."
    - docker stop grafana || true
    - docker rm grafana || true

    - echo "Starting Grafana with PostgreSQL as its database and provisioning settings..."
    - docker run -d --name=grafana 
        -p 4000:3000 
        -v grafana_data:/var/lib/grafana 
        -v $CI_PROJECT_DIR/grafana/provisioning:/etc/grafana/provisioning 
        -v $CI_PROJECT_DIR/grafana/dashboards:/var/lib/grafana/dashboards 
        grafana/grafana:latest  # ğŸ”¥ `-e GF_DATABASE_*` í™˜ê²½ ë³€ìˆ˜ ì œê±°

    - sleep 15

    - echo "Testing Grafana provisioning..."
    - curl -s -u admin:admin http://localhost:4000/api/datasources
    - curl -s -u admin:admin http://localhost:4000/api/search?query=

